<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>

  <PropertyGroup>
    <!-- Inject object model building. Must be after Microsoft.CSharp.targets is imported. -->
    <CompileDependsOn>BuildAndInjectObjectModel;$(CompileDependsOn)</CompileDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <JsonSchemaToDotNetPath>..\packages\Microsoft.Json.Schema.ToDotNet.0.7.0\tools\JsonSchemaToDotNet.exe</JsonSchemaToDotNetPath>
    <_ObjectModelOutputDirectory>$(FlavorIndependentIntermediateOutputPath)Autogenerated</_ObjectModelOutputDirectory>
  </PropertyGroup>
  
  <!-- This target runs only when we actually need to build the object model files, which should be
       only when the JSON schema changes. -->
  <Target Name="BuildObjectModel" Inputs="@(JsonSchemaFile)" Outputs="$(_ObjectModelOutputDirectory)\*.cs">
    <MakeDir Directories="$(_ObjectModelOutputDirectory)" />
    <ItemGroup>
      <FileWrites Include="$(_ObjectModelOutputDirectory)" />
    </ItemGroup>

    <Exec Command="&quot;$(JsonSchemaToDotNetPath)&quot; --schema-name Sarif --schema-file-path &quot;%(JsonSchemaFile.FullPath)&quot; --output-directory &quot;$(_ObjectModelOutputDirectory)&quot; --force-overwrite --namespace-name %(JsonSchemaFile.Namespace) --root-class-name %(JsonSchemaFile.RootClassName) --copyright-file-path &quot;%(JsonSchemaFile.CopyrightFilePath)&quot; --hints-file-path &quot;%(JsonSchemaFile.HintsFilePath)&quot;" />
    <Message Text="Generated classes from @(JsonSchemaFile) -> $(_ObjectModelOutputDirectory)"/>
  </Target>
  <!--
  This target runs every build. It runs the grammar generator (if necessary) and injects
  the outputs thereof into the C# build.
  -->
  <Target Name="BuildAndInjectObjectModel">
    <!-- Build the object model if necessary. -->
    <CallTarget Targets="BuildObjectModel" />
    
    <ItemGroup>
      <!-- FileWrites are the set of files that get deleted on clean. -->
      <FileWrites Include="$(_ObjectModelOutputDirectory)\*.cs" />
      <!-- Compile are the set of files that go into the C# build. -->
      <Compile Include="$(_ObjectModelOutputDirectory)\*.cs" />
    </ItemGroup>
  </Target>
</Project>